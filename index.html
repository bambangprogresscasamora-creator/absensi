
<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Absensi Online (HTML + Apps Script — JSONP)</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --line:#e2e8f0; --text:#0f172a; --muted:#475569; --brand:#4f46e5; }
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);max-width:760px;margin:24px auto;padding:0 14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  h1{font-size:1.25rem;margin:.25rem 0 1rem}
  label{font-size:.9rem;color:var(--muted)}
  input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--brand);color:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  small{color:var(--muted)}
  .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:.75rem}
  ul{list-style:none;margin:0;padding:0}
  li{border-bottom:1px dashed var(--line);padding:10px 2px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
<h1>Absensi Online</h1>
<div class="card">
  <div class="row">
    <div>
      <label>Nama</label>
      <input id="nama" placeholder="Nama lengkap">
    </div>
    <div style="flex:0 0 auto">
      <button id="pakai">Gunakan</button>
    </div>
  </div>
  <div style="margin-top:8px">
    <small id="locStatus" style="display:none">Mengecek lokasi…</small>
  </div>
  <div class="row" style="margin-top:8px">
    <button id="absen" disabled>Absen</button>
    <button id="refresh">Refresh Riwayat</button>
    <button id="regeo">Refresh Lokasi</button>
    <button id="export">Export CSV</button>
  </div>
  <div style="margin-top:8px"><small class="mono" id="msg"></small></div>
  <div style="margin-top:8px"><small id="permHint" style="color:#b91c1c;display:none"></small></div>
</div>

<!-- Panel Koordinat Manual (darurat) -->
<div class="card" id="manualBox" style="display:none">
  <h3 style="margin:0 0 8px 0">Mode Koordinat Manual (darurat)</h3>
  <div class="row">
    <div><label>Lat</label><input id="manualLat" placeholder="-6.480672"></div>
    <div><label>Lon</label><input id="manualLon" placeholder="106.873117"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <button id="useManual">Gunakan Koordinat Manual</button>
  </div>
  <small>Ambil dari Google Maps → tekan lama lokasi → salin koordinat (format: <code>lat, lon</code>), lalu paste di atas.</small>
</div>

<div class="card">
  <div class="row" style="align-items:baseline">
    <h3 style="margin:0;flex:0 0 auto">Riwayat (nama ini)</h3>
    <div style="text-align:right"><span id="summary" class="pill">—</span></div>
  </div>
  <ul id="list"></ul>
</div>

<script>
/** ========= KONFIGURASI ========= */
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbwdfaPvzJBwQF_3fef0Gopa8JfHzD6GgUHQkBezEV4eRMOt4VaA-M0s2rkCUvYhmMp6iQ/exec';  // sudah diisi
const APP_TOKEN    = 'indonesia';     // sudah diisi
const OFFICE = { lat: -6.480671890901518, lon: 106.8731167368355, radius_m: 50 };
/** ================================= */

const el = {
  nama: document.getElementById('nama'),
  pakai: document.getElementById('pakai'),
  absen: document.getElementById('absen'),
  refresh: document.getElementById('refresh'),
  regeo: document.getElementById('regeo'),
  exportBtn: document.getElementById('export'),
  msg: document.getElementById('msg'),
  locStatus: document.getElementById('locStatus'),
  list: document.getElementById('list'),
  summary: document.getElementById('summary'),
  permHint: document.getElementById('permHint'),
};

const LS_NAMA = 'absen_gas_nama';
let lastPos = null;
let watchId = null;
let geoTimer = null;

function fmt2(n){return String(n).padStart(2,'0');}
function nowLocalISO(){
  const d = new Date();
  return d.getFullYear()+'-'+fmt2(d.getMonth()+1)+'-'+fmt2(d.getDate())+' '+fmt2(d.getHours())+':'+fmt2(d.getMinutes())+':'+fmt2(d.getSeconds());
}
function toRad(x){return x*Math.PI/180;}
function haversine_m(lat1,lon1,lat2,lon2){
  const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function setMsg(s){ el.msg.textContent = s; }

// ====== JSONP helper (hindari CORS untuk GET & INSERT) ======
function jsonp(url, cbName){
  return new Promise((resolve, reject)=>{
    const name = cbName || ('cb_' + Math.random().toString(36).slice(2));
    const cleanup = ()=>{ try{ delete window[name]; }catch(_){} if(script && script.parentNode) script.parentNode.removeChild(script); };
    window[name] = (data)=>{ resolve(data); cleanup(); };
    const script = document.createElement('script');
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
    script.onerror = ()=>{ reject(new Error('JSONP failed')); cleanup(); };
    document.body.appendChild(script);
  });
}

// API (semua via JSONP agar lolos CORS dari GitHub Pages)
async function apiInsert(row){
  const params = new URLSearchParams();
  params.set('action','insert');
  params.set('token', row.token);
  params.set('nama', row.nama);
  params.set('lat', String(row.lat));
  params.set('lon', String(row.lon));
  params.set('jarak_client', String(row.jarak_client));
  params.set('akurasi', String(row.akurasi));
  params.set('waktu_client', row.waktu_client);
  const url = ENDPOINT_URL + '?' + params.toString();
  return await jsonp(url);
}
async function apiList(nama){
  const url = ENDPOINT_URL + '?action=list&nama=' + encodeURIComponent(nama);
  return await jsonp(url);
}

function renderList(rows){
  const my = rows.slice().sort((a,b)=>a.waktu.localeCompare(b.waktu));
  el.list.innerHTML = '';
  if(!my.length){ el.summary.textContent='Belum ada data'; return; }
  el.summary.textContent = `Total ${my.length} • ${new Set(my.map(r=>r.waktu.slice(0,10))).size} hari`;
  my.reverse().forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<b>${r.waktu}</b> • ${r.jarak_m} m<br><small class="mono">lat ${r.lat}, lon ${r.lon}</small>`;
    el.list.appendChild(li);
  });
}
function exportCSV(rows){
  if(!rows || !rows.length){ alert('Belum ada data'); return; }
  const headers = ['nama','waktu','lat','lon','jarak_m'];
  const lines = [headers.join(',')];
  rows.forEach(r=>lines.push([r.nama,r.waktu,r.lat,r.lon,r.jarak_m].join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'absensi_'+(el.nama.value||'').replace(/\s+/g,'_')+'.csv';
  a.click(); URL.revokeObjectURL(a.href);
}

// ====== Permission & fallback tips ======
async function checkPermissionAndTips(){
  try{ if (!('permissions' in navigator)) return;
    const st = await navigator.permissions.query({name:'geolocation'});
    if (st.state === 'denied'){
      el.permHint.style.display = 'block';
      el.permHint.textContent = 'Izin lokasi DITOLAK. Buka Pengaturan situs → Location: Allow, nyalakan Precise/High accuracy.';
    }
  }catch(_){}
}
function startGeoTimer(){
  if (geoTimer) clearTimeout(geoTimer);
  geoTimer = setTimeout(()=>{
    if(!lastPos){
      el.permHint.style.display='block';
      el.permHint.textContent = 'Masih menunggu GPS… izinkan lokasi atau gunakan Koordinat Manual.';
      const box = document.getElementById('manualBox'); if(box) box.style.display = 'block';
    }
  }, 8000);
}
function stopGeoTimer(){ if (geoTimer){ clearTimeout(geoTimer); geoTimer = null; } }
let geoFirstFix = false;
function markGotFix(){ geoFirstFix = true; stopGeoTimer(); el.permHint.style.display='none'; }

// ====== GEO: cepat dulu, akurat kemudian ======
function initGeo(){
  el.locStatus.style.display = 'inline';
  el.locStatus.textContent = 'Meminta lokasi…';
  checkPermissionAndTips();
  startGeoTimer();

  if(!('geolocation' in navigator)){ el.locStatus.textContent = 'Geolocation tidak didukung.'; return; }

  const quickOpts   = { enableHighAccuracy:false, timeout:3000, maximumAge:900000 }; // cache 15m
  const preciseOpts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 };

  navigator.geolocation.getCurrentPosition(pos=>{
    lastPos = pos.coords;
    el.absen.disabled = false;
    markGotFix();
    el.locStatus.textContent = `Lokasi awal (±${Math.round(pos.coords.accuracy||0)} m)`;
  }, err=>{
    el.locStatus.textContent = 'Menunggu GPS… ' + err.message;
  }, quickOpts);

  if(watchId !== null) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos=>{
    lastPos = pos.coords;
    markGotFix();
    el.locStatus.textContent = `Lokasi akurat (±${Math.round(pos.coords.accuracy||0)} m)`;
  }, err=>{ }, preciseOpts);
}

// ====== Events ======
document.getElementById('useManual').onclick = ()=>{
  const lat = parseFloat((document.getElementById('manualLat').value||'').trim());
  const lon = parseFloat((document.getElementById('manualLon').value||'').trim());
  if (isNaN(lat) || isNaN(lon)){ alert('Koordinat tidak valid'); return; }
  lastPos = { latitude: lat, longitude: lon, accuracy: 999 };
  el.locStatus.style.display='inline';
  el.locStatus.textContent = `Koordinat manual dipakai (${lat.toFixed(6)}, ${lon.toFixed(6)})`;
  el.absen.disabled = false;
};

el.regeo.onclick = ()=>{ el.locStatus.style.display='inline'; el.locStatus.textContent = 'Menyegarkan lokasi…'; initGeo(); };

el.pakai.onclick = async ()=>{
  if (el.locStatus.style.display === 'none') { el.locStatus.style.display='inline'; }
  el.locStatus.textContent = 'Meminta lokasi…';
  initGeo();

  const n = (el.nama.value||'').trim();
  if(!n){ alert('Isi nama dulu'); return; }
  localStorage.setItem(LS_NAMA, n);
  setMsg('Menarik riwayat…');
  try{ const res = await apiList(n); if(res.ok){ renderList(res.rows||[]); setMsg(''); } else setMsg('Gagal: '+(res.error||'unknown')); }
  catch(e){ setMsg('Gagal: '+e); }
};

el.refresh.onclick = el.pakai.onclick;

el.absen.onclick = async ()=>{
  const nama = (el.nama.value||'').trim();
  if(!nama){ alert('Isi nama dulu'); return; }
  if(!lastPos){
    el.locStatus.style.display='inline';
    el.locStatus.textContent = 'Meminta lokasi…'; initGeo();
    alert('Sedang mengambil lokasi. Coba klik Absen lagi setelah status menunjukkan lokasi.');
    return;
  }
  const jarak = Math.round(haversine_m(lastPos.latitude, lastPos.longitude, OFFICE.lat, OFFICE.lon));
  const acc = Math.round(lastPos.accuracy||0);
  const allowed = OFFICE.radius_m + Math.min(50, Math.floor(acc/2));
  if(jarak > allowed){
    alert(`Terlalu jauh: ${jarak} m (akurasi ±${acc} m). Tunggu GPS stabil atau mendekat.`);
    return;
  }
  const payload = {
    token: APP_TOKEN,
    nama,
    lat: Number(lastPos.latitude.toFixed(6)),
    lon: Number(lastPos.longitude.toFixed(6)),
    jarak_client: jarak,
    akurasi: acc,
    waktu_client: nowLocalISO(),
  };
  setMsg('Mengirim absen…');
  try{
    const res = await apiInsert(payload); // JSONP insert (anti-CORS)
    if(!res.ok){ setMsg('Gagal: '+(res.error||'unknown')); alert('Gagal: '+(res.error||'unknown')); return; }
    setMsg(`Sukses. Jarak server: ${res.jarak_m} m`);
    const list = await apiList(nama);
    if(list.ok) renderList(list.rows||[]);
  }catch(e){ setMsg('Gagal kirim: '+e); }
};

// Init (tidak auto-minta lokasi). Auto-isi nama jika ada.
const saved = localStorage.getItem(LS_NAMA)||'';
if(saved){ el.nama.value = saved; }
</script>
</body>
</html>
